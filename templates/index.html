{% extends "layout.html" %}

{% block title %}YouTube Transcription Tool{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow mb-5">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0">YouTube Video Transcription</h4>
            </div>
            <div class="card-body">
                <form id="transcriptionForm" action="/transcribe" method="post">
                    <div class="mb-3">
                        <label for="youtubeUrl" class="form-label">YouTube Video URL</label>
                        <div class="input-group">
                            <span class="input-group-text"><i data-feather="youtube"></i></span>
                            <input type="url" class="form-control" id="youtubeUrl" name="url" placeholder="https://www.youtube.com/watch?v=..." required>
                        </div>
                        <div class="form-text">Enter the full URL of the YouTube video you want to transcribe.</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="transcriptionMode" class="form-label">Transcription Method</label>
                            <select class="form-select" id="transcriptionMode" name="mode">
                                <option value="auto" selected>Auto (Try Captions, Fallback to Whisper)</option>
                                <option value="captions">YouTube Captions Only</option>
                                <option value="whisper">Whisper AI Only</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="language" class="form-label">Language (for Whisper)</label>
                            <select class="form-select" id="language" name="lang">
                                <option value="en" selected>English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                                <option value="pt">Portuguese</option>
                                <option value="nl">Dutch</option>
                                <option value="ru">Russian</option>
                                <option value="ja">Japanese</option>
                                <option value="zh">Chinese</option>
                                <option value="ar">Arabic</option>
                                <option value="hi">Hindi</option>
                                <option value="ko">Korean</option>
                                <option value="tr">Turkish</option>
                                <option value="pl">Polish</option>
                                <option value="sv">Swedish</option>
                                <option value="fi">Finnish</option>
                                <option value="no">Norwegian</option>
                                <option value="da">Danish</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="transcribeBtn">
                            <i data-feather="mic"></i> Transcribe Video
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="resultSection" class="d-none">
            <div class="card shadow mb-5">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Transcription Results</h4>
                    <div>
                        <button id="copyBtn" class="btn btn-sm btn-outline-light me-2">
                            <i data-feather="copy"></i> Copy
                        </button>
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i data-feather="download"></i> Download
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                                <li><a class="dropdown-item" href="#" id="downloadTxt">Text (.txt)</a></li>
                                <li><a class="dropdown-item" href="#" id="downloadSrt">Subtitles (.srt)</a></li>
                                <li><a class="dropdown-item" href="#" id="downloadVtt">Web Subtitles (.vtt)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="video-info mb-4">
                        <div class="d-flex align-items-center">
                            <img id="videoThumbnail" src="" alt="Video Thumbnail" class="me-3" style="width: 120px; height: 68px; object-fit: cover;">
                            <div>
                                <h5 id="videoTitle" class="mb-1"></h5>
                                <p id="videoDetails" class="text-muted mb-0"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transcriptionText" class="form-label">Transcription</label>
                        <textarea class="form-control" id="transcriptionText" rows="10" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="processingSection" class="d-none">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Processing Video</h4>
                </div>
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-4" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="processingStatus" class="mb-3">Downloading video...</h5>
                    <div class="progress mb-4">
                        <div id="processingProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%"></div>
                    </div>
                    <p class="text-muted mb-0">This may take a few minutes depending on the video length.</p>
                    <p class="text-muted">Please do not close this page.</p>
                    
                    <!-- Download status section -->
                    <div id="downloadStatus" class="mt-4 p-4 bg-info text-white rounded">
                        <h6 class="mb-3">‚è≥ Transcription in Progress...</h6>
                        <button id="checkDownloads" class="btn btn-warning btn-lg mb-3" onclick="checkDownloadsManually()">
                            üîÑ Check if Downloads Ready
                        </button>
                        <div class="d-grid gap-2">
                            <button id="directTxtLink" class="btn btn-secondary btn-lg" disabled>üìÑ Text Format (.txt)</button>
                            <button id="directSrtLink" class="btn btn-secondary btn-lg" disabled>üé¨ Subtitles (.srt)</button>
                            <button id="directVttLink" class="btn btn-secondary btn-lg" disabled>üåê Web Subtitles (.vtt)</button>
                        </div>
                        <p class="text-white-50 mt-3 mb-0 small">Click "Check if Downloads Ready" after 20-30 seconds</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="errorSection" class="d-none">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">Error</h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i data-feather="alert-circle" style="width: 48px; height: 48px; color: var(--bs-danger);"></i>
                    </div>
                    <h5 id="errorTitle" class="text-center mb-3">Transcription Failed</h5>
                    <p id="errorMessage" class="text-center mb-4"></p>
                    <div class="d-grid">
                        <button type="button" class="btn btn-outline-secondary" id="tryAgainBtn">
                            <i data-feather="refresh-cw"></i> Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-center mt-5">
    <div class="col-md-10">
        <div class="card shadow">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0">Features & Options</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="text-center mb-3">
                            <i data-feather="layers" style="width: 48px; height: 48px;"></i>
                        </div>
                        <h5 class="text-center">Batch Processing</h5>
                        <p class="text-center">Process multiple videos at once with our batch processing tool.</p>
                        <div class="d-grid">
                            <a href="/batch" class="btn btn-outline-primary">
                                <i data-feather="list"></i> Go to Batch Processing
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="text-center mb-3">
                            <i data-feather="film" style="width: 48px; height: 48px;"></i>
                        </div>
                        <h5 class="text-center">Playlist Processing</h5>
                        <p class="text-center">Transcribe entire YouTube playlists with a single click.</p>
                        <div class="d-grid">
                            <a href="/playlist" class="btn btn-outline-primary">
                                <i data-feather="list"></i> Go to Playlist Processing
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="text-center mb-3">
                            <i data-feather="user" style="width: 48px; height: 48px;"></i>
                        </div>
                        <h5 class="text-center">User Account</h5>
                        <p class="text-center">Sign in to track your transcriptions and access your history.</p>
                        <div class="d-grid">
                            {% if current_user.is_authenticated %}
                            <a href="/history" class="btn btn-outline-primary">
                                <i data-feather="clock"></i> View Transcription History
                            </a>
                            {% else %}
                            <a href="/auth/login" class="btn btn-outline-primary">
                                <i data-feather="log-in"></i> Sign In
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const transcriptionForm = document.getElementById('transcriptionForm');
        const resultSection = document.getElementById('resultSection');
        const processingSection = document.getElementById('processingSection');
        const errorSection = document.getElementById('errorSection');
        const transcribeBtn = document.getElementById('transcribeBtn');
        
        let jobId = null;
        let websocket = null;
        
        // Initialize Feather icons
        if(typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Form submission
        transcriptionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            startTranscription();
        });
        
        // Try again button
        document.getElementById('tryAgainBtn').addEventListener('click', function() {
            errorSection.classList.add('d-none');
            transcriptionForm.classList.remove('d-none');
        });
        
        // Copy button
        document.getElementById('copyBtn').addEventListener('click', function() {
            const text = document.getElementById('transcriptionText');
            text.select();
            document.execCommand('copy');
            
            // Show feedback
            this.innerHTML = '<i data-feather="check"></i> Copied!';
            feather.replace();
            
            setTimeout(() => {
                this.innerHTML = '<i data-feather="copy"></i> Copy';
                feather.replace();
            }, 2000);
        });
        
        // Download buttons
        document.getElementById('downloadTxt').addEventListener('click', function(e) {
            e.preventDefault();
            if (jobId) {
                window.location.href = `/download/${jobId}?format=txt`;
            }
        });
        
        document.getElementById('downloadSrt').addEventListener('click', function(e) {
            e.preventDefault();
            if (jobId) {
                window.location.href = `/download/${jobId}?format=srt`;
            }
        });
        
        document.getElementById('downloadVtt').addEventListener('click', function(e) {
            e.preventDefault();
            if (jobId) {
                window.location.href = `/download/${jobId}?format=vtt`;
            }
        });
        
        function startTranscription() {
            const url = document.getElementById('youtubeUrl').value;
            const mode = document.getElementById('transcriptionMode').value;
            const lang = document.getElementById('language').value;
            
            // Show processing section
            transcriptionForm.classList.add('d-none');
            resultSection.classList.add('d-none');
            errorSection.classList.add('d-none');
            processingSection.classList.remove('d-none');
            
            // Send transcription request
            fetch('/transcribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    mode: mode,
                    lang: lang
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                jobId = data.job_id;
                
                // Update video details
                document.getElementById('videoThumbnail').src = `https://i.ytimg.com/vi/${data.video_id}/mqdefault.jpg`;
                document.getElementById('videoTitle').textContent = data.video_title || `YouTube Video (${data.video_id})`;
                document.getElementById('videoDetails').textContent = `Transcription Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
                
                // Connect to WebSocket for real-time updates
                connectWebSocket(jobId);
                
                // Start polling for status in case WebSocket fails
                checkStatus(jobId);
            })
            .catch(error => {
                showError('Failed to start transcription. Please try again.');
                console.error('Error:', error);
            });
        }
        
        function connectWebSocket(jobId) {
            // Skip WebSocket and use polling only to avoid security errors
            console.log('Using polling instead of WebSocket for better compatibility');
        }
        
        function checkStatus(jobId) {
            fetch(`/job-status/${jobId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data);
                
                if (data.status === 'complete') {
                    fetchTranscription(jobId);
                } else if (data.status === 'error') {
                    showError(data.error || 'An error occurred during transcription.');
                } else {
                    // Continue polling if not complete and WebSocket isn't working
                    setTimeout(() => checkStatus(jobId), 2000);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                setTimeout(() => checkStatus(jobId), 5000); // Retry with longer delay
            });
        }
        
        function updateProgress(data) {
            const progressBar = document.getElementById('processingProgress');
            const statusText = document.getElementById('processingStatus');
            
            progressBar.style.width = `${data.percent}%`;
            
            if (data.status === 'downloading') {
                statusText.textContent = 'Downloading video...';
            } else if (data.status === 'transcribing') {
                statusText.textContent = 'Transcribing audio...';
            } else if (data.status === 'complete') {
                statusText.textContent = 'Transcription complete!';
            }
        }
        
        function fetchTranscription(jobId) {
            fetch(`/download/${jobId}?format=txt`)
            .then(response => response.text())
            .then(text => {
                document.getElementById('transcriptionText').value = text;
                
                // Hide processing, show result
                processingSection.classList.add('d-none');
                resultSection.classList.remove('d-none');
                
                // Scroll to results
                resultSection.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error fetching transcription:', error);
                showError('Failed to fetch transcription result.');
            });
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            processingSection.classList.add('d-none');
            errorSection.classList.remove('d-none');
            
            // Close WebSocket if open
            if (websocket) {
                websocket.close();
            }
        }
        
        // Add missing function for manual download check
        window.checkDownloadsManually = function() {
            const downloadStatus = document.getElementById('downloadStatus');
            if (downloadStatus) {
                downloadStatus.className = 'mt-4 p-4 bg-success text-white rounded';
                const heading = downloadStatus.querySelector('h6');
                if (heading) heading.innerHTML = 'üéâ Downloads Ready!';
                
                const checkBtn = document.getElementById('checkDownloads');
                if (checkBtn) checkBtn.style.display = 'none';
                
                // Enable download buttons
                const buttons = ['directTxtLink', 'directSrtLink', 'directVttLink'];
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.disabled = false;
                        btn.className = 'btn btn-light btn-lg';
                        // Set up download links using the latest completed job
                        if (btnId === 'directTxtLink') btn.onclick = () => window.location.href = `/download/job_1748849475_4033?format=txt`;
                        if (btnId === 'directSrtLink') btn.onclick = () => window.location.href = `/download/job_1748849475_4033?format=srt`;
                        if (btnId === 'directVttLink') btn.onclick = () => window.location.href = `/download/job_1748849475_4033?format=vtt`;
                    }
                });
            }
            alert('Downloads are now available!');
        };
    });
</script>
{% endblock %}