{% extends "layout.html" %}

{% block title %}Playlist Processing{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i data-feather="list" class="me-2"></i>
        Playlist Processing
    </h1>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Process YouTube Playlist</h5>
                </div>
                <div class="card-body">
                    <form id="playlistForm">
                        <div class="mb-3">
                            <label for="playlist_url" class="form-label">YouTube Playlist URL</label>
                            <input type="url" class="form-control" id="playlist_url" name="playlist_url" 
                                   placeholder="https://www.youtube.com/playlist?list=..." required>
                            <div class="form-text">Enter the complete YouTube playlist URL</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="mode" class="form-label">Processing Mode</label>
                                <select class="form-select" id="mode" name="mode">
                                    <option value="auto">Auto (Captions first, then Whisper)</option>
                                    <option value="captions">Captions Only</option>
                                    <option value="whisper">Whisper AI Only</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="lang" class="form-label">Language</label>
                                <select class="form-select" id="lang" name="lang">
                                    <option value="auto">Auto-detect</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="ru">Russian</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ar">Arabic</option>
                                    <option value="hi">Hindi</option>
                                    <option value="fi">Finnish</option>
                                    <option value="sv">Swedish</option>
                                    <option value="no">Norwegian</option>
                                    <option value="da">Danish</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i data-feather="play" class="me-2"></i>
                            Process Playlist
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">How Playlist Processing Works</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <i data-feather="link" class="me-2 mt-1 text-primary"></i>
                        <div>
                            <strong>Extract Videos</strong>
                            <p class="mb-0 small text-muted">We extract all video URLs from the playlist</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-start mb-3">
                        <i data-feather="cpu" class="me-2 mt-1 text-success"></i>
                        <div>
                            <strong>Process Each Video</strong>
                            <p class="mb-0 small text-muted">Each video is transcribed using your selected mode</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-start mb-3">
                        <i data-feather="download" class="me-2 mt-1 text-info"></i>
                        <div>
                            <strong>Download Results</strong>
                            <p class="mb-0 small text-muted">All transcriptions are packaged into a ZIP file</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Supported Formats</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <i data-feather="file-text" class="text-primary mb-2"></i>
                            <div class="small">TXT</div>
                        </div>
                        <div class="col-4">
                            <i data-feather="subtitles" class="text-success mb-2"></i>
                            <div class="small">SRT</div>
                        </div>
                        <div class="col-4">
                            <i data-feather="video" class="text-info mb-2"></i>
                            <div class="small">VTT</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Processing Playlist</h5>
                <span id="progressText">Preparing...</span>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="currentVideo" class="text-muted"></div>
                <div id="videosList" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="check-circle" class="me-2 text-success"></i>
                    Playlist Processing Complete
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Your playlist has been successfully processed. All transcriptions are ready for download.</p>
                <div id="downloadLinks" class="d-grid gap-2 d-md-flex"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('playlistForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentVideo = document.getElementById('currentVideo');
    
    // Show progress section
    progressSection.style.display = 'block';
    resultsSection.style.display = 'none';
    
    try {
        const response = await fetch('/transcribe', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.job_id) {
            // Use polling instead of WebSocket to avoid security errors
            pollPlaylistStatus(result.job_id);
        }
        
        function pollPlaylistStatus(jobId) {
            const pollInterval = setInterval(() => {
                fetch(`/api/job-status/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.progress !== undefined) {
                            progressBar.style.width = data.progress + '%';
                            progressBar.textContent = Math.round(data.progress) + '%';
                        }
                        
                        if (data.status) {
                            progressText.textContent = data.status;
                        }
                        
                        if (data.current_video) {
                            currentVideo.textContent = `Processing: ${data.current_video}`;
                        }
                        
                        if (data.status === 'completed') {
                            clearInterval(pollInterval);
                            progressSection.style.display = 'none';
                            resultsSection.style.display = 'block';
                            
                            // Show download links
                            const downloadLinks = document.getElementById('downloadLinks');
                            downloadLinks.innerHTML = `
                                <a href="/api/download/${jobId}?format=zip" class="btn btn-primary">
                                    <i data-feather="download" class="me-2"></i>Download ZIP
                                </a>
                            `;
                            feather.replace();
                        }
                        
                        if (data.status === 'failed') {
                            clearInterval(pollInterval);
                            progressText.textContent = 'Processing failed: ' + (data.error || 'Unknown error');
                            progressBar.classList.add('bg-danger');
                        }
                    })
                    .catch(error => {
                        console.error('Polling error:', error);
                        // Continue polling even on error
                    });
            }, 3000);
            
            // Stop polling after 30 minutes
            setTimeout(() => {
                clearInterval(pollInterval);
                progressText.textContent = 'Processing timeout. Please check downloads page.';
            }, 1800000);
        }
    } catch (error) {
        console.error('Error:', error);
        progressText.textContent = 'Error submitting playlist. Please try again.';
    }
});
</script>
{% endblock %}